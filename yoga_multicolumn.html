<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>20250920 Yoga â€” å¤šæ¬„é¡¯ç¤º</title>
  <style>
    :root{--columns:1;--base-font:20px;--min-font:6px}
    html,body{height:100%;margin:0;background:#f7f7f8;font-family:-apple-system,BlinkMacSystemFont,'Noto Sans TC','Microsoft JhengHei',Roboto,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .page{box-sizing:border-box;width:100vw;height:100vh;padding:68px 40px 28px 40px;display:block;overflow:hidden}
    .sheet{height:100%;column-count:var(--columns);column-width:auto;column-gap:20px;column-fill:auto;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(250,250,252,0.95));padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06);border-radius:10px;overflow:auto;font-size:var(--base-font);line-height:1.45;column-rule:none}

    .sheet * {
      box-sizing: border-box;
    }
    h1{font-size:1.25em;margin:0 0 8px 0;break-inside:avoid}
    h2{font-size:0.98em;margin:6px 0 6px 0}
    ul,ol{margin:4px 0 12px 0;padding-left:1.1em;list-style-position:inside}
    li{margin:4px 0}
    h1,h2,li{break-inside:avoid-column}

    li::marker {
      display: inline-block;
      width: auto;
    }

    ol li, ul li {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    /* Chrome ç€è¦½å™¨å¤šæ¬„ä½ˆå±€ ::marker ä¿®å¾© */
    @supports (column-count: 1) {
      ol {
        counter-reset: list-counter;
      }

      ol li {
        list-style: none;
        counter-increment: list-counter;
        position: relative;
      }

      ol li::before {
        content: counter(list-counter) ". ";
        font-weight: normal;
        margin-right: 0.5em;
      }
    }

    @page{size:landscape}

    .toolbar{position:fixed;top:8px;left:8px;right:8px;background:rgba(255,255,255,0.95);border-radius:8px;padding:6px 8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:100;display:flex;gap:8px;align-items:center;font-size:13px;flex-wrap:wrap}
    .toolbar label{display:flex;gap:6px;align-items:center;white-space:nowrap}
    .toolbar select,.toolbar button,.toolbar input{font-size:13px;padding:6px;border-radius:6px;border:1px solid #e6e6e9;background:#fff;cursor:pointer;min-width:0}
    .toolbar button[aria-pressed="true"]{background:#eaf3ff;border-color:#cfe6ff}

    .toolbar-narrow{display:none;position:fixed;top:8px;left:8px;right:8px;background:rgba(255,255,255,0.95);border-radius:8px;padding:4px 6px;box-shadow:0 6px 18px rgba(0,0,0,0.08);z-index:100;flex-wrap:wrap;gap:4px;align-items:center;justify-content:center;transition:transform 0.3s ease}
    .toolbar-narrow button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #e6e6e9;background:#fff;cursor:pointer;min-width:36px;height:36px;display:flex;align-items:center;justify-content:center}
    .toolbar-narrow button[aria-pressed="true"]{background:#eaf3ff;border-color:#cfe6ff}
    .toolbar-narrow.hidden{transform:translateY(-100%)}
    .toolbar-narrow.minimized{transform:translateY(-80%)}

    @media(max-width:768px){
      .toolbar{display:none}
      .toolbar-narrow{display:flex}
      .page{padding:60px 16px 16px 16px;transition:padding 0.3s ease}
      .page.toolbar-hidden{padding:16px 16px 16px 16px}
    }

    @media(max-width:480px){
      .page{padding:60px 8px 8px 8px}
    }

    @media (hover: none) and (pointer: coarse) {
      button {
        min-height: 44px;
        min-width: 44px;
        padding: 8px 12px;
        touch-action: manipulation;
      }

      .sheet {
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
        touch-action: pan-y pinch-zoom;
      }

      .toolbar-narrow button {
        min-height: 48px;
        min-width: 48px;
        font-size: 16px;
      }

      body {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }
    }

    .sheet:active {
      background-color: rgba(0,0,0,0.02);
    }

    /* Memory styles */
    .memorized {
      opacity: 0.6;
      text-decoration: line-through;
      background-color: rgba(0, 200, 0, 0.1);
    }

    .hidden-line {
      display: none !important;
    }

    .completed-last {
      color: red !important;
      font-weight: bold !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <nav class="toolbar" aria-label="æ–‡ä»¶æ§åˆ¶">
      <button id="colBtn" title="åˆ‡æ›æ¬„æ•¸ (å¿«æ·éµ 1-6)">ğŸ“‘ 1æ¬„</button>

      <label>ğŸ”¤
        <input type="number" id="fontPreset" title="å­—å‹å¤§å° (å¿«æ·éµ +/-)" value="20" min="6" max="128" step="1" style="width: 60px;">
      </label>

      <button id="fontDecBtn" title="ç¸®å°å­—å‹ (å¿«æ·éµ -)">-</button>
      <button id="fontIncBtn" title="æ”¾å¤§å­—å‹ (å¿«æ·éµ +)">+</button>

      <button id="memBtn" aria-pressed="false" title="åˆ‡æ›é»˜èƒŒæ¨¡å¼ï¼šæŒ‰ä¸€æ¬¡éš±è—å…¨éƒ¨ï¼Œå†æŒ‰ç©ºç™½æˆ– M é¡¯ç¤ºä¸‹ä¸€è¡Œ">ğŸ“– é»˜èƒŒæ¨¡å¼ (M / Space)</button>
      <button id="autoPlaySlowBtn" title="è‡ªå‹•æ’­æ”¾æ¸›é€Ÿ">ğŸŒ</button>
      <button id="autoPlayBtn" aria-pressed="false" title="è‡ªå‹•æ’­æ”¾é»˜èƒŒæ¨¡å¼ â€” å¿«æ·éµ A">â–¶ï¸ è‡ªå‹•æ’­æ”¾ 120â™© (A)</button>
      <button id="autoPlayFastBtn" title="è‡ªå‹•æ’­æ”¾åŠ é€Ÿ">ğŸ°</button>
      <button id="resetMemBtn" title="é‡ç½®é»˜èƒŒä¸¦é¡¯ç¤ºå…¨éƒ¨ â€” å¿«æ·éµ R">ğŸ”„ é‡ç½® (R)</button>
      <button id="copyBtn" title="è¤‡è£½å…¨éƒ¨å…§å®¹åˆ°å‰ªè²¼ç°¿ â€” å¿«æ·éµ C">ğŸ“‹ è¤‡è£½å…¨éƒ¨ (C)</button>
      <button id="helpBtn" title="é¡¯ç¤ºä½¿ç”¨èªªæ˜">â“ èªªæ˜</button>
    </nav>

    <!-- çª„è¢å¹•å°ˆç”¨å·¥å…·åˆ— -->
    <nav class="toolbar-narrow" aria-label="æ–‡ä»¶æ§åˆ¶">
      <button id="toggleToolbarBtn" title="åˆ‡æ›å·¥å…·åˆ—é¡¯ç¤º" style="position: absolute; right: 8px; top: 4px; padding: 4px 8px; font-size: 12px;">âš™ï¸</button>
      <button id="colBtnNarrow" title="åˆ‡æ›æ¬„æ•¸">ğŸ“‘</button>
      <button id="fontDecBtnNarrow" title="ç¸®å°å­—å‹">ğŸ”¤-</button>
      <button id="fontIncBtnNarrow" title="æ”¾å¤§å­—å‹">ğŸ”¤+</button>
      <button id="memBtnNarrow" aria-pressed="false" title="é»˜èƒŒæ¨¡å¼">ğŸ“–</button>
      <button id="autoPlaySlowBtnNarrow" title="æ¸›é€Ÿ">ğŸŒ</button>
      <button id="autoPlayBtnNarrow" aria-pressed="false" title="è‡ªå‹•æ’­æ”¾">â–¶ï¸120â™©</button>
      <button id="autoPlayFastBtnNarrow" title="åŠ é€Ÿ">ğŸ°</button>
      <button id="resetMemBtnNarrow" title="é‡ç½®">ğŸ”„</button>
      <button id="copyBtnNarrow" title="è¤‡è£½">ğŸ“‹</button>
      <button id="helpBtnNarrow" title="èªªæ˜">â“</button>
    </nav>

    <div id="sheet" class="sheet">
    </div>
  </div>

  <script>
    // Markdown content for yoga practice
    const yogaContent = `# 20250920 Yoga

## A 00:00 8å€‹8æ‹(å‰å¥)
1. éŸ³æ¨‚é–‹å§‹5678
2. 22345678
3. å¤–æ‰‹åˆå5678
4. å…§æ‰‹åˆå5678
5. ä¸­é–“åˆæŒ5678
6. è½‰å‘345678
7. æ‰‹ä¸Š34å¾Œå½78
8. æ‰‹ä¸Š34åˆå78

## B 00:30 16å€‹8æ‹(äººè²)
1. åº§æ¤…345678
2. ç«™å§¿å‰å½5678
3. å¸æ°£é ­æŠ¬åæ°£å‰å½
4. å¾Œè·³ä¸‹çŠ¬5678
5. å¹³æ¿34è¶´ä¸‹78
6. è›‡å¼34ä¸‹çŠ¬78
7. å³è…³å¾ŒæŠ¬å‰è·¨78
8. ä¸Šè‹±é›„ä¸€5678
9. æ‰‹ä¸‹34ä¸‹çŠ¬78
10. å¹³æ¿34è¶´ä¸‹78
11. è›‡å¼34ä¸‹çŠ¬78
12. å·¦è…³å¾ŒæŠ¬å‰è·¨78
13. ä¸Šè‹±é›„ä¸€5678
14. æ‰‹ä¸‹34ä¸‹çŠ¬78
15. å‰è·³34å‰å½78
16. åº§æ¤…345678

## C 01:30 8å€‹8æ‹(é‡äººè²) ç«™å§¿
1. é›™æ‰‹åŠƒé–‹å±±å¼å›æ­£
2. é›™æ‰‹å‘ä¸Š5678
3. å·¦å´å½æ›²5678
4. å·¦å´å½å›5678
5. æ‰‹ä¸‹3456æ’è…°
6. å·¦è†å‰æŠ¬å·¦è†å¤–é–‹
7. åˆå345678
8. æ‰‹ä¸Š34æ‰‹ä¸‹è…³ä¸‹

## D 01:59 2å€‹8æ‹(ç„¡äººè²)è®Šæ›éšŠå½¢
1. è½‰135é¢å‘å‰é¢
2. è½‰24æ’é¢å‘å¾Œé¢

## E 02:05 16å€‹8æ‹(äººè²)
1. åº§æ¤…345678
2. ç«™å§¿å‰å½5678
3. å¸æ°£é ­æŠ¬åæ°£å‰å½
4. å¾Œè·³ä¸‹çŠ¬5678
5. å¹³æ¿34è¶´ä¸‹78
6. è›‡å¼34ä¸‹çŠ¬78
7. å³è…³å¾ŒæŠ¬å‰è·¨78
8. ä¸Šè‹±é›„ä¸€5678
9. æ‰‹ä¸‹34ä¸‹çŠ¬78
10. å¹³æ¿34è¶´ä¸‹78
11. è›‡å¼34ä¸‹çŠ¬78
12. å·¦è…³å¾ŒæŠ¬å‰è·¨78
13. ä¸Šè‹±é›„ä¸€5678
14. æ‰‹ä¸‹34ä¸‹çŠ¬78
15. å‰è·³34å‰å½78
16. åº§æ¤…345678

## F 03:05 8å€‹8æ‹(é‡äººè²) ç«™å§¿
1. é›™æ‰‹åŠƒé–‹å±±å¼å›æ­£
2. é›™æ‰‹å‘ä¸Š5678
3. å³å´å½æ›²5678
4. å³å´å½å›5678
5. æ‰‹ä¸‹3456æ’è…°
6. å³è†å‰æŠ¬å³è†å¤–é–‹
7. åˆå345678
8. æ‰‹ä¸Š34æ‰‹ä¸‹è…³ä¸‹

## G 03:35 10å€‹8æ‹(ç¯€å¥ç„¡äººè²)
1. é›™æ‰‹å‘ä¸Š5678
2. ç«™å§¿å‰å½5678
3. å³è…³å·¦è…³æº–å‚™å¬°å…’ / çƒé´‰é å‚™5678
4. å¬°å…’1æ¬¡5678      / çƒé´‰ä¸Šå»5678
5. å¬°å…’2æ¬¡5678      / çƒé´‰åœä½5678
6. ä¸‹çŠ¬1æ¬¡5678      / ä¸­é–“å¬°å…’5678
7. ä¸‹çŠ¬2æ¬¡5678      / ä¸­é–“å¬°å…’5678
8. ä¸‹çŠ¬34å¹³æ¿78
9. è¶´ä¸‹345678
10. è›‡å¼345678

## H 04:11 10å€‹8æ‹(å¾®éœ‡æ’¼ç„¡äººè²)
1. ä¸‹çŠ¬345678
2. å…§è·¨34è½‰å¤–78     # å…§è·¨æŒ‡è¿‘ä¸­é–“
3. å¸æ°£é ­æŠ¬åæ°£å‰å½
4. å‰æ‰‹æ’è…°å‰æ‰‹å±•é–‹
5. æ‰‹ä¸‹345678
6. å¾Œæ‰‹æ’è…°å¾Œæ‰‹å±•é–‹
7. æ‰‹ä¸‹345678
8. å¾Œè½‰34æ”¶è…³78
9. è¹²234æŠ±èºº78
10. é å‚™è¼ªå¼5678

## I 04:48 10å€‹8æ‹(å¾®éœ‡æ’¼ç„¡äººè²)
1. ä¸Š2345678  # 135æ’æ©‹å¼, 24æ’è¼ªå¼
2. æ’ä½34ä¸‹678
3. æŠ±è…³345678
4. å‰æ»¾ç«™èµ·5678
5. èµ°ä½345678
6. é›™äººä¸‹çŠ¬5678
7. å€’ç«‹æº–å‚™5678
8. ä¸Š2345678
9. æ’ä½345678
10. å³ä¸‹å·¦ä¸‹å°é½Šç«™èµ·  # åŒæ™‚åˆå

---
**çµæŸ**`;

    function parseMarkdownToHTML(markdown) {
      let html = '';
      const lines = markdown.split('\n');

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (line.startsWith('# ')) {
          html += `<h1>${line.substring(2)}</h1>\n`;
        } else if (line.startsWith('## ')) {
          html += `<h2>${line.substring(3)}</h2>\n`;
        } else if (/^\d+\./.test(line)) {
          // Start or continue ordered list
          if (i === 0 || !(/^\d+\./.test(lines[i-1].trim()))) {
            html += '<ol>\n';
          }
          html += `<li>${line.replace(/^\d+\.\s*/, '')}</li>\n`;
          // Check if next line is not a list item
          if (i === lines.length - 1 || !(/^\d+\./.test(lines[i+1].trim()))) {
            html += '</ol>\n';
          }
        } else if (line === '---') {
          // Skip horizontal rules in markdown
        } else if (line.startsWith('**') && line.endsWith('**')) {
          html += `<h2 id="endMarker" style="text-align: center; color: #888; margin-top: 30px;">â€” ${line.slice(2, -2)} â€”</h2>\n`;
        } else if (line === '') {
          // Skip empty lines
        }
      }

      return html;
    }

    function loadContentFromMarkdown() {
      const contentHTML = parseMarkdownToHTML(yogaContent);
      sheet.innerHTML = contentHTML;
    }

    function initializeAfterContentLoad() {
      // Check if content is loaded by verifying elements exist
      const elements = sheet.querySelectorAll('h1, h2, li');
      if (elements.length === 0) {
        // Content not ready yet, try again
        setTimeout(initializeAfterContentLoad, 50);
        return;
      }

      // Content is ready, proceed with initialization
      applyInitialSettings();
      initMemMode();
      updateAutoPlayButtons();
      setTimeout(checkToolbarWrap, 100);
    }

    const DEFAULT_FONT_SIZE = 20;

    const sheet = document.getElementById('sheet');
    const fontPreset = document.getElementById('fontPreset');
    const memBtn = document.getElementById('memBtn');
    const resetMemBtn = document.getElementById('resetMemBtn');
    const copyBtn = document.getElementById('copyBtn');
    const fontDecBtn = document.getElementById('fontDecBtn');
    const fontIncBtn = document.getElementById('fontIncBtn');
    const autoPlayBtn = document.getElementById('autoPlayBtn');
    const autoPlaySlowBtn = document.getElementById('autoPlaySlowBtn');
    const autoPlayFastBtn = document.getElementById('autoPlayFastBtn');

    const colBtn = document.getElementById('colBtn');

    const colBtnNarrow = document.getElementById('colBtnNarrow');
    const fontDecBtnNarrow = document.getElementById('fontDecBtnNarrow');
    const fontIncBtnNarrow = document.getElementById('fontIncBtnNarrow');
    const memBtnNarrow = document.getElementById('memBtnNarrow');
    const autoPlayBtnNarrow = document.getElementById('autoPlayBtnNarrow');
    const autoPlaySlowBtnNarrow = document.getElementById('autoPlaySlowBtnNarrow');
    const autoPlayFastBtnNarrow = document.getElementById('autoPlayFastBtnNarrow');
    const resetMemBtnNarrow = document.getElementById('resetMemBtnNarrow');
    const copyBtnNarrow = document.getElementById('copyBtnNarrow');
    const toggleToolbarBtn = document.getElementById('toggleToolbarBtn');
    const helpBtn = document.getElementById('helpBtn');
    const helpBtnNarrow = document.getElementById('helpBtnNarrow');

    let allLines = [];
    let memActive = false;
    let memIndex = 0;
    let autoPlayActive = false;
    let autoPlayTimer = null;
    let currentColumns = 1;
    let toolbarVisible = true;
    let autoPlaySpeed = 120; // BPM (beats per minute)

    function getAutoPlayInterval() {
      // æ¯è¡Œ8æ‹ï¼Œæ‰€ä»¥é–“éš” = (60000ms / BPM) * 8
      return (60000 / autoPlaySpeed) * 8;
    }

    function setColumnCount(count) {
      currentColumns = count;
      sheet.style.columnCount = count;
      sheet.style.columnWidth = 'auto';
      sheet.style.columnRule = 'none';
      sheet.setAttribute('data-columns', count);

      const display = sheet.style.display;
      sheet.style.display = 'none';
      // eslint-disable-next-line no-unused-expressions
      sheet.offsetHeight;
      sheet.style.display = display;      updateColumnButtons();
    }

    function applyInitialSettings(){
      sheet.style.fontSize = fontPreset.value + 'px';

      const maxColumns = calculateMaxColumns();
      setColumnCount(maxColumns);
    }

    function updateColumnButtons(){
      colBtn.textContent = `ğŸ“‘ ${currentColumns}æ¬„`;
      colBtnNarrow.textContent = `ğŸ“‘${currentColumns}`;
    }

    function updateAutoPlayButtons(){
      const speedText = `${autoPlaySpeed}â™©`;
      autoPlayBtn.innerHTML = `â–¶ï¸ è‡ªå‹•æ’­æ”¾ ${speedText} (A)`;
      autoPlayBtnNarrow.innerHTML = `â–¶ï¸${speedText}`;
    }

    function changeAutoPlaySpeed(delta) {
      autoPlaySpeed = Math.max(60, Math.min(200, autoPlaySpeed + delta));
      updateAutoPlayButtons();

      // If auto play is active, restart with new speed
      if (autoPlayActive) {
        clearInterval(autoPlayTimer);
        autoPlayTimer = setInterval(() => {
          if (memActive && memIndex < allLines.length) {
            revealNextLine();
          } else {
            autoPlayActive = false;
            autoPlayBtn.setAttribute('aria-pressed', 'false');
            autoPlayBtnNarrow.setAttribute('aria-pressed', 'false');
            if (autoPlayTimer) {
              clearInterval(autoPlayTimer);
              autoPlayTimer = null;
            }
          }
        }, getAutoPlayInterval());
      }
    }

    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let lastTouchEnd = 0;

    sheet.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchStartTime = Date.now();
      }
    }, { passive: true });

    function handleDoubleTap(touchEndTime) {
      const isDoubleTap = touchEndTime - lastTouchEnd <= 300;
      lastTouchEnd = touchEndTime;
      return isDoubleTap;
    }

    function handleTap(deltaX, deltaY, deltaTime, e) {
      if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10 && deltaTime < 200) {
        e.preventDefault();
        if (!memActive) {
          toggleMemMode();
        } else {
          revealNextLine();
        }
        return true;
      }
      return false;
    }

    function handleHorizontalSwipe(deltaX, e) {
      e.preventDefault();
      if (deltaX > 0) {
        toggleColumns();
      } else {
        const maxColumns = calculateMaxColumns();
        const nextColumns = currentColumns <= 1 ? maxColumns : currentColumns - 1;
        setColumnCount(nextColumns);
      }
    }

    function handleVerticalSwipe(deltaY, e) {
      e.preventDefault();
      if (deltaY < 0) {
        changeFont(2);
      } else {
        changeFont(-2);
      }
    }

    function handleSwipeGestures(deltaX, deltaY, deltaTime, e) {
      const minSwipeDistance = 50;
      const maxSwipeTime = 500;

      if (deltaTime >= maxSwipeTime) {
        return;
      }

      if (Math.abs(deltaX) > minSwipeDistance && Math.abs(deltaX) > Math.abs(deltaY)) {
        handleHorizontalSwipe(deltaX, e);
      }
      else if (Math.abs(deltaY) > minSwipeDistance && Math.abs(deltaY) > Math.abs(deltaX)) {
        handleVerticalSwipe(deltaY, e);
      }
    }

    sheet.addEventListener('touchend', (e) => {
      if (e.changedTouches.length !== 1) {
        return;
      }

      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const touchEndTime = Date.now();

      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const deltaTime = touchEndTime - touchStartTime;

      if (handleDoubleTap(touchEndTime)) {
        e.preventDefault();
        return;
      }

      if (handleTap(deltaX, deltaY, deltaTime, e)) {
        return;
      }

      handleSwipeGestures(deltaX, deltaY, deltaTime, e);
    }, { passive: false });

    function toggleColumns(){
      const maxColumns = calculateMaxColumns();
      const nextColumns = currentColumns >= maxColumns ? 1 : currentColumns + 1;
      setColumnCount(nextColumns);
    }

    function toggleToolbar(){
      const toolbarNarrow = document.querySelector('.toolbar-narrow');
      const page = document.querySelector('.page');

      if(toolbarVisible){
        toolbarNarrow.classList.add('minimized');
        page.classList.add('toolbar-hidden');
        toggleToolbarBtn.textContent = 'â–¼';
        toolbarVisible = false;
      } else {
        toolbarNarrow.classList.remove('minimized');
        page.classList.remove('toolbar-hidden');
        toggleToolbarBtn.textContent = 'âš™ï¸';
        toolbarVisible = true;
      }
    }

    function calculateMaxColumns(){
      const viewportWidth = window.innerWidth - 80;
      const fontSize = parseInt(window.getComputedStyle(sheet).fontSize) || DEFAULT_FONT_SIZE;

      const testDiv = document.createElement('div');
      testDiv.style.cssText = `
        position: absolute;
        top: -9999px;
        font-family: ${window.getComputedStyle(sheet).fontFamily};
        font-size: ${fontSize}px;
        line-height: 1.45;
        white-space: nowrap;
        visibility: hidden;
      `;
      document.body.appendChild(testDiv);

      let maxLineWidth = 0;
      const lines = sheet.querySelectorAll('h1, h2, li');
      lines.forEach(line => {
        testDiv.textContent = line.textContent;
        maxLineWidth = Math.max(maxLineWidth, testDiv.offsetWidth);
      });

      document.body.removeChild(testDiv);

      const minColumnWidth = maxLineWidth + 40;
      const maxPossibleColumns = Math.floor(viewportWidth / minColumnWidth);
      return Math.max(1, Math.min(maxPossibleColumns, 6));
    }

    function responsiveColumnAdjust(){
      const maxColumns = calculateMaxColumns();
      setColumnCount(maxColumns);
    }

    function checkToolbarWrap(){
      if (window.innerWidth <= 768) {
        return;
      }

      const toolbar = document.querySelector('.toolbar');
      const toolbarNarrow = document.querySelector('.toolbar-narrow');

      toolbar.style.display = 'flex';
      toolbarNarrow.style.display = 'none';

      setTimeout(() => {
        const buttons = toolbar.querySelectorAll('button, label');
        if (buttons.length < 2) return;

        const firstButton = buttons[0];
        const lastButton = buttons[buttons.length - 1];

        const firstRect = firstButton.getBoundingClientRect();
        const lastRect = lastButton.getBoundingClientRect();

        const isWrapped = Math.abs(firstRect.top - lastRect.top) > 10;

        if (isWrapped) {
          toolbar.style.display = 'none';
          toolbarNarrow.style.display = 'flex';
        }
      }, 10);
    }

    colBtn.addEventListener('click', toggleColumns);
    colBtnNarrow.addEventListener('click', toggleColumns);

    fontPreset.addEventListener('input', ()=>{
      const minFont = parseInt(fontPreset.min) || 6;
      const maxFont = parseInt(fontPreset.max) || 128;
      const fontSize = Math.max(minFont, Math.min(maxFont, parseInt(fontPreset.value) || DEFAULT_FONT_SIZE));
      fontPreset.value = fontSize;
      sheet.style.fontSize = fontSize + 'px';
      responsiveColumnAdjust();
      setTimeout(checkToolbarWrap, 100);
    });

    function changeFont(delta){
      const cur = parseInt(window.getComputedStyle(sheet).fontSize) || DEFAULT_FONT_SIZE;
      const minFont = parseInt(fontPreset.min) || 6;
      const maxFont = parseInt(fontPreset.max) || 128;
      const next = Math.max(minFont, Math.min(maxFont, cur + delta));
      sheet.style.fontSize = next + 'px';
      document.getElementById('fontPreset').value = next;
      responsiveColumnAdjust();
      setTimeout(checkToolbarWrap, 100);
    }

    function setColumns(n){
      const maxColumns = calculateMaxColumns();
      const num = Math.min(maxColumns, Math.max(1, Number(n)));
      setColumnCount(num);
    }

    function initMemMode(){
      const listItems = sheet.querySelectorAll('li');
      const h2Items = sheet.querySelectorAll('h2');

      // Make li elements clickable without checkboxes
      listItems.forEach((li, index) => {
        li.style.cursor = 'pointer';
        li.style.userSelect = 'none';
        li.dataset.index = index;
        li.addEventListener('click', handleLiClick);
      });

      // Make h2 elements clickable for group control
      h2Items.forEach((h2, index) => {
        h2.style.cursor = 'pointer';
        h2.style.userSelect = 'none';
        h2.dataset.h2Index = index;
        h2.addEventListener('click', handleH2Click);
      });

      allLines = Array.from(sheet.querySelectorAll('li'));
      memActive = false;
      memIndex = 0;
      allLines.forEach(el => el.classList.remove('hidden-line', 'memorized'));
      memBtn.setAttribute('aria-pressed','false');
    }

    function handleLiClick(event) {
      event.preventDefault();
      event.stopPropagation();

      const li = event.currentTarget;

      // Toggle memorized state
      if (li.classList.contains('memorized')) {
        li.classList.remove('memorized');
      } else {
        li.classList.add('memorized');
      }

      // Clear completed state when manually changing memory state
      li.classList.remove('completed-last');

      // Update memory mode display if active
      if (memActive) {
        updateMemoryDisplay();
      }
    }

    function handleH2Click(event) {
      event.preventDefault();
      event.stopPropagation();

      const h2 = event.currentTarget;

      // Find all li elements that belong to this h2 section
      let currentElement = h2.nextElementSibling;
      const sectionLiElements = [];

      while (currentElement && currentElement.tagName !== 'H2') {
        if (currentElement.tagName === 'OL' || currentElement.tagName === 'UL') {
          // If it's a list, get all li elements inside it
          const lis = currentElement.querySelectorAll('li');
          sectionLiElements.push(...lis);
        } else if (currentElement.tagName === 'LI') {
          sectionLiElements.push(currentElement);
        }
        currentElement = currentElement.nextElementSibling;
      }

      // Check current state of all li elements in this section
      const memorizedCount = sectionLiElements.filter(li => li.classList.contains('memorized')).length;
      const totalCount = sectionLiElements.length;

      let shouldMemorize;
      if (memorizedCount === 0) {
        // All unmemorized -> memorize all
        shouldMemorize = true;
      } else if (memorizedCount === totalCount) {
        // All memorized -> unmemorize all
        shouldMemorize = false;
      } else {
        // Partially memorized -> unmemorize all
        shouldMemorize = false;
      }

      // Apply the new state to all li elements in this section
      sectionLiElements.forEach(li => {
        if (shouldMemorize) {
          li.classList.add('memorized');
        } else {
          li.classList.remove('memorized');
        }
        // Clear completed state when manually changing memory state
        li.classList.remove('completed-last');
      });

      // Update memory mode display if active
      if (memActive) {
        updateMemoryDisplay();
      }
    }

    function updateMemoryDisplay() {
      allLines.forEach(li => {
        if (li.classList.contains('memorized')) {
          // Keep memorized items visible
          li.classList.remove('hidden-line');
        } else if (memActive) {
          // Hide unmemorized items in memory mode
          li.classList.add('hidden-line');
        }
      });
    }

    function hideUnmemorizedLines(){
      allLines.forEach(li => {
        if (!li.classList.contains('memorized')) {
          li.classList.add('hidden-line');
        }
      });
    }

    function revealNextLine(){
      // Find next unmemorized line
      while(memIndex < allLines.length) {
        const li = allLines[memIndex];

        if (!li.classList.contains('memorized')) {
          // This is an unmemorized line, reveal it
          li.classList.remove('hidden-line');

          // è‡ªå‹•æ»¾å‹•åˆ°æœ€å¾Œé¡¯ç¤ºçš„è¡Œ
          li.scrollIntoView({
            behavior: 'smooth',
            block: 'end'
          });

          memIndex++;
          return;
        }

        // Skip memorized lines
        memIndex++;
      }

      // No more unmemorized lines - mark the end marker as completed
      const endMarker = document.getElementById('endMarker');
      if (endMarker) {
        endMarker.classList.add('completed-last');
      }

      memActive = false;
      memBtn.setAttribute('aria-pressed','false');
      memBtnNarrow.setAttribute('aria-pressed','false');
      memIndex = 0;
    }

    function toggleMemMode(){
      if(!memActive){
        hideUnmemorizedLines();
        memActive = true;
        memIndex = 0;
        memBtn.setAttribute('aria-pressed','true');
        memBtnNarrow.setAttribute('aria-pressed','true');
      } else {
        revealNextLine();
      }
    }

    function resetMem(){
      allLines.forEach(el => {
        el.classList.remove('hidden-line', 'memorized', 'completed-last');
      });

      // Also clear the end marker
      const endMarker = document.getElementById('endMarker');
      if (endMarker) {
        endMarker.classList.remove('completed-last');
      }

      memActive = false;
      memIndex = 0;
      autoPlayActive = false;
      if(autoPlayTimer) {
        clearInterval(autoPlayTimer);
        autoPlayTimer = null;
      }
      memBtn.setAttribute('aria-pressed','false');
      autoPlayBtn.setAttribute('aria-pressed','false');
      memBtnNarrow.setAttribute('aria-pressed','false');
      autoPlayBtnNarrow.setAttribute('aria-pressed','false');

      resetFontSize();
    }

    function resetFontSize() {
      fontPreset.value = DEFAULT_FONT_SIZE;
      sheet.style.fontSize = DEFAULT_FONT_SIZE + 'px';

      const maxColumns = calculateMaxColumns();
      setColumnCount(maxColumns);
    }

    function showHelp() {
      const helpContent = `
ğŸ“– ç‘œä¼½ç·´ç¿’é é¢ä½¿ç”¨èªªæ˜

âš¡ å¿«é€Ÿæ“ä½œ
ğŸ’» é›»è…¦ï¼šSpaceéµ=è¨˜æ†¶æ¨¡å¼ | Réµ=é‡ç½® | Méµ=è¨˜æ†¶åˆ‡æ›
ğŸ“± è§¸æ§ï¼šå–®æ“Š=è¨˜æ†¶æ¨¡å¼ | å·¦å³æ»‘=èª¿æ¬„æ•¸ | ä¸Šä¸‹æ»‘=èª¿å­—å‹

 Memoryæ¨¡å¼é¡¯ç¤ºé‚è¼¯
â€¢ é †åºé¡¯ç¤ºï¼šå¤šæ¬„æ¨¡å¼ä¸‹å…ˆé¡¯ç¤ºå®Œç¬¬ä¸€æ¬„ï¼Œå†é¡¯ç¤ºç¬¬äºŒæ¬„
â€¢ è¡Œç´šæ§åˆ¶ï¼šæ¯æ¬¡æŒ‰ç©ºç™½éµæˆ–Méµé¡¯ç¤ºä¸‹ä¸€è¡Œå…§å®¹
â€¢ è‡ªå‹•æ’­æ”¾ï¼šå¯è¨­å®šæ¯4ç§’è‡ªå‹•é¡¯ç¤ºä¸‹ä¸€è¡Œ

ğŸ“± è§¸æ§æ‰‹å‹¢æ“ä½œ
ğŸ‘† å–®æ“Šï¼šç­‰åŒç©ºç™½éµï¼Œé€²å…¥è¨˜æ†¶æ¨¡å¼æˆ–é¡¯ç¤ºä¸‹ä¸€è¡Œ
ğŸ‘ˆğŸ‘‰ å·¦å³æ»‘å‹•ï¼šèª¿æ•´æ¬„æ•¸ (â†’å³æ»‘å¢åŠ ï¼Œâ†å·¦æ»‘æ¸›å°‘)
ğŸ‘†ğŸ‘‡ ä¸Šä¸‹æ»‘å‹•ï¼šèª¿æ•´å­—å‹ (â†‘ä¸Šæ»‘æ”¾å¤§ï¼Œâ†“ä¸‹æ»‘ç¸®å°)

âŒ¨ï¸ éµç›¤å¿«æ·éµ
Spaceï¼šè¨˜æ†¶æ¨¡å¼åˆ‡æ›/é¡¯ç¤ºä¸‹ä¸€è¡Œ
Rï¼šé‡ç½® | Mï¼šè¨˜æ†¶æ¨¡å¼åˆ‡æ› | Aï¼šè‡ªå‹•æ’­æ”¾åˆ‡æ›
Cï¼šè¤‡è£½å…¨éƒ¨å…§å®¹ | +/-ï¼šæ”¾å¤§/ç¸®å°å­—å‹ | 1-6ï¼šç›´æ¥è¨­å®šæ¬„æ•¸
      `;

      alert(helpContent);
    }

    function toggleAutoPlay(){
      if(!autoPlayActive){
        if(!memActive){
          toggleMemMode();
        }
        autoPlayActive = true;
        autoPlayBtn.setAttribute('aria-pressed','true');
        autoPlayBtnNarrow.setAttribute('aria-pressed','true');

        // Immediately reveal the next line without delay
        if(memActive && memIndex < allLines.length){
          revealNextLine();
        }

        autoPlayTimer = setInterval(()=>{
          if(memActive && memIndex < allLines.length){
            revealNextLine();
          } else {
            autoPlayActive = false;
            autoPlayBtn.setAttribute('aria-pressed','false');
            autoPlayBtnNarrow.setAttribute('aria-pressed','false');
            if(autoPlayTimer) {
              clearInterval(autoPlayTimer);
              autoPlayTimer = null;
            }
          }
        }, getAutoPlayInterval());
      } else {
        autoPlayActive = false;
        autoPlayBtn.setAttribute('aria-pressed','false');
        autoPlayBtnNarrow.setAttribute('aria-pressed','false');
        if(autoPlayTimer) {
          clearInterval(autoPlayTimer);
          autoPlayTimer = null;
        }
      }
    }

    function copyAll(){
      const visibleElements = Array.from(sheet.querySelectorAll('h1, h2, ol')).filter(el =>
        !el.classList.contains('hidden-line')
      );

      const text = visibleElements.map(node => {
        if (node.tagName === 'OL') {
          const visibleItems = Array.from(node.querySelectorAll('li')).filter(li =>
            !li.classList.contains('hidden-line')
          ).map((li, index) => {
            return `${index + 1}. ${li.textContent}`;
          }).join('\n');
          return visibleItems;
        } else {
          return node.innerText;
        }
      }).join('\n\n');

      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          const prev = copyBtn.innerText;
          copyBtn.innerText = 'å·²è¤‡è£½';
          setTimeout(()=>copyBtn.innerText = prev,900);
        }).catch(()=>{
          alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–å¾Œè¤‡è£½');
        });
      } else {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´å‰ªè²¼ç°¿ APIï¼Œè«‹æ‰‹å‹•è¤‡è£½');
      }
    }

    document.addEventListener('keydown', (e) => {
      const activeTag = document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT' || document.activeElement.isContentEditable);
      if(activeTag) return;

      if(e.code === 'Space'){
        e.preventDefault();
        if(!memActive){ toggleMemMode(); } else { revealNextLine(); }
        return;
      }

      switch(e.key){
        case 'm': case 'M': e.preventDefault(); toggleMemMode(); break;
        case 'a': case 'A': e.preventDefault(); toggleAutoPlay(); break;
        case 'r': case 'R': e.preventDefault(); resetMem(); break;
        case 'c': case 'C': e.preventDefault(); copyAll(); break;
        case '+': case '=': e.preventDefault(); changeFont(1); break;
        case '-': e.preventDefault(); changeFont(-1); break;
        case '1': case '2': case '3': case '4': case '5': case '6': e.preventDefault(); setColumns(Number(e.key)); break;
      }
    });

    memBtn.addEventListener('click', (e)=>{ toggleMemMode(); });
    autoPlayBtn.addEventListener('click', (e)=>{ toggleAutoPlay(); });
    resetMemBtn.addEventListener('click', resetMem);
    copyBtn.addEventListener('click', copyAll);
    fontDecBtn.addEventListener('click', ()=>{ changeFont(-1); });
    fontIncBtn.addEventListener('click', ()=>{ changeFont(1); });
    toggleToolbarBtn.addEventListener('click', toggleToolbar);
    helpBtn.addEventListener('click', showHelp);

    autoPlaySlowBtn.addEventListener('click', () => changeAutoPlaySpeed(-10));
    autoPlayFastBtn.addEventListener('click', () => changeAutoPlaySpeed(10));
    autoPlaySlowBtnNarrow.addEventListener('click', () => changeAutoPlaySpeed(-10));
    autoPlayFastBtnNarrow.addEventListener('click', () => changeAutoPlaySpeed(10));

    memBtnNarrow.addEventListener('click', ()=>{
      toggleMemMode();
      memBtnNarrow.setAttribute('aria-pressed', memBtn.getAttribute('aria-pressed'));
    });
    autoPlayBtnNarrow.addEventListener('click', ()=>{
      toggleAutoPlay();
      autoPlayBtnNarrow.setAttribute('aria-pressed', autoPlayBtn.getAttribute('aria-pressed'));
    });
    resetMemBtnNarrow.addEventListener('click', resetMem);
    copyBtnNarrow.addEventListener('click', copyAll);
    fontDecBtnNarrow.addEventListener('click', ()=>{ changeFont(-1); });
    fontIncBtnNarrow.addEventListener('click', ()=>{ changeFont(1); });
    helpBtnNarrow.addEventListener('click', showHelp);

    window.addEventListener('load', ()=>{
      fontPreset.value = DEFAULT_FONT_SIZE;
      sheet.style.fontSize = DEFAULT_FONT_SIZE + 'px';

      loadContentFromMarkdown();

      // Initialize after content is fully loaded
      initializeAfterContentLoad();
    });

    window.addEventListener('resize', ()=>{
      responsiveColumnAdjust();
      setTimeout(checkToolbarWrap, 100);
    });
  </script>
</body>
</html>
